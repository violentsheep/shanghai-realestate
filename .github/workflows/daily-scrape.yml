name: æ¯æ—¥é‡‡é›†ä¸Šæµ·æˆ¿åœ°äº§æ•°æ®

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 08:00 è¿è¡Œï¼ˆUTC 00:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  scrape:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æäº¤æ•°æ®æ–‡ä»¶

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£… Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          cd scraper
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: è¿è¡Œé‡‡é›†è„šæœ¬
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          cd scraper
          python scrape.py

      - name: æäº¤æ•°æ®æ›´æ–°
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Data Bot"
          git add data/
          git diff --staged --quiet || git commit -m "ğŸ“Š æ•°æ®æ›´æ–°: $(date '+%Y-%m-%d')"
          git push

  deploy:
    needs: scrape
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          ref: main  # ç¡®ä¿æ‹¿åˆ°æœ€æ–°æäº¤ï¼ˆå«æ•°æ®ï¼‰

      - name: å®‰è£… Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: å®‰è£…å‰ç«¯ä¾èµ–
        run: |
          cd frontend
          pnpm install

      - name: æ„å»ºå‰ç«¯
        run: |
          cd frontend
          pnpm build

      - name: éƒ¨ç½²åˆ° Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: frontend
          vercel-args: '--prod'
