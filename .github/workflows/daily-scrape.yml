name: æ¯æ—¥é‡‡é›†ä¸Šæµ·æˆ¿åœ°äº§æ•°æ®

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 08:30ï¼ˆUTC 00:30ï¼‰
    - cron: '30 0 * * *'
  workflow_dispatch:

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    steps:
      - name: æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£… Python ä¾èµ–
        run: |
          cd scraper
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: è¿è¡Œé‡‡é›†è„šæœ¬
        env:
          BAIDU_OCR_API_KEY: ${{ secrets.BAIDU_OCR_API_KEY }}
          BAIDU_OCR_SECRET_KEY: ${{ secrets.BAIDU_OCR_SECRET_KEY }}
        run: |
          cd scraper
          python scrape.py

      - name: æäº¤æ•°æ®åˆ°ä»“åº“
        run: |
          git config user.email "bot@github-actions"
          git config user.name "Data Bot"
          git add data/history/data.json
          git diff --staged --quiet || git commit -m "ğŸ“Š æ•°æ®æ›´æ–°: $(date '+%Y-%m-%d')"
          git push

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: æ„å»ºå‰ç«¯
        run: |
          cd frontend
          pnpm install
          BUILD_MODE=prod pnpm build

      - name: éƒ¨ç½²åˆ° GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/dist
